
#' Water Supply Vulnerability Metric
#'
#' Water supply vulnerability measures measures the average volumetric severity of failure during a failure period and
#'  
#' 
#' @param x vector specifying series of supply values
#' @param y vector specifying series of supply values
#'
#' @return numeric value displaying reliability from 0 to 100
#' @export
#'
#' @examples
mVulnerability <- function(x, y, dimensionless = TRUE) {
  
  df <- tibble(x, y) %>% mutate(z = x-y, z1 = ifelse(z ==  0, 0, 1), z2 = rep(0, length(z)))
  
  for (i in 1:length(df$z)) {
    
    if (i == 1) {
      
      df$z2[i] <- ifelse(df$z1[i] == 0, 0, 1)  
      
    } else {
      
      df$z2[i] <- ifelse(df$z1[i] == 0, 0, ifelse(df$z1[i-1] == 0 & df$z1[i] == 1, max(df$z2) + 1, df$z2[i-1]))
    }
  }
  
  zmax <- df %>% group_by(z2) %>% summarize(zmax = max(z)) %>% filter(z2 > 0) %>% pull(zmax)
  zmax <- ifelse(length(zmax) == 0, 0 , zmax)
  
  if (dimensionless == TRUE) {
    return(mean(zmax) / mean(x))
  } else {
    return(mean(zmax))
  }
  
}


x <- df$waterGap

mVulnerability2 <- function(x) {
  
  dur_lengths <- RLE$lengths[which(RLE$values == TRUE)]
  gap_indices <- which(x > 0)
  
  
  
  rle(x>0)$lengths [which(rle_z$values == TRUE)]
  x_nonzero <- which(x >0)
  
  
  index_beg <- 1
  local_max <- vector(mode = "numeric", length = length(dur_lengths))
  
  for (i in 1:length(dur_lengths)) {
  
    if(i != 1) index_beg <- index_end + 1 
    index_end <- index_beg + dur_lengths[i]-1
    local_max[i] <-max(x[gap_indices[index_beg:index_end]])
    
  }
  
  mean(local_max)
  
  
  
  

  